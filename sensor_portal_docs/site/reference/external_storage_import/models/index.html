<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>models - ARISE MDS sensor portal help</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "models";
        var mkdocs_page_input_path = "reference\\external_storage_import\\models.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> ARISE MDS sensor portal help
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../about/">About</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Data structure</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../structure/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../structure/project/">Project</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../structure/device/">Device</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../structure/deployment/">Deployment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../structure/datafile/">Datafile</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Model detail</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/site/">Site</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/datatype/">DataType</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/project/">Project</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/devicemodel/">DeviceModel</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/device/">Device</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/deployment/">Deployment</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/datafile/">DataFile</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/taxon/">Taxon</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/observation/">Observation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../structure/detail/datapackage/">DataPackage</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/">Index</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/arise_mds_api_examples/">Examples</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../api/upload_data_workflow/">Upload example</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">For developers</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../../developers/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../developers/data_handlers/">Data handlers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../developers/generic_jobs/">Generic jobs</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Code Reference</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../../ai_integration/">ai_integration</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../ai_integration/tasks/">tasks</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../archiving/">archiving</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../archiving/bagit_functions/">bagit_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../archiving/functions/">functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../archiving/models/">models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../archiving/tar_functions/">tar_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../archiving/tasks/">tasks</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../camtrap_dp_export/">camtrap_dp_export</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../camtrap_dp_export/metadata_functions/">metadata_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../camtrap_dp_export/querysets/">querysets</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../camtrap_dp_export/serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../camtrap_dp_export/viewsets/">viewsets</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../data_handlers/">data_handlers</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../data_handlers/base_data_handler_class/">base_data_handler_class</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_handlers/functions/">functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_handlers/post_upload_task_handler/">post_upload_task_handler</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_handlers/serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_handlers/tasks/">tasks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_handlers/viewsets/">viewsets</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../data_models/">data_models</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/file_handling_functions/">file_handling_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/filtersets/">filtersets</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/general_functions/">general_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/job_handling_functions/">job_handling_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/metadata_functions/">metadata_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/models/">models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/plotting_functions/">plotting_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/rules/">rules</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/signals/">signals</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/tasks/">tasks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/validators/">validators</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_models/viewsets/">viewsets</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../data_packages/">data_packages</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../data_packages/create_zip_functions/">create_zip_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_packages/models/">models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_packages/serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_packages/tasks/">tasks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../data_packages/viewsets/">viewsets</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../dsi/">dsi</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../dsi/api_client/">api_client</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../dsi/api_functions/">api_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../dsi/tasks/">tasks</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="../">external_storage_import</a>
    <ul class="current">
                <li class="toctree-l3"><a class="reference internal" href="../filtersets/">filtersets</a>
                </li>
                <li class="toctree-l3 current"><a class="reference internal current" href="#">models</a>
    <ul class="current">
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../tasks/">tasks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../viewsets/">viewsets</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../observation_editor/">observation_editor</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../observation_editor/filtersets/">filtersets</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../observation_editor/GBIF_functions/">GBIF_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../observation_editor/metadata_functions/">metadata_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../observation_editor/models/">models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../observation_editor/rules/">rules</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../observation_editor/serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../observation_editor/tasks/">tasks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../observation_editor/viewsets/">viewsets</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../user_management/">user_management</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../user_management/filtersets/">filtersets</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../user_management/models/">models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../user_management/rules/">rules</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../user_management/serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../user_management/signals/">signals</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../user_management/views/">views</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../user_management/viewsets/">viewsets</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/">utils</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/api_renderer/">api_renderer</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/email/">email</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/filtersets/">filtersets</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/general/">general</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/models/">models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/paginators/">paginators</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/perm_functions/">perm_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/querysets/">querysets</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/rules/">rules</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/serializers/">serializers</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/ssh_client/">ssh_client</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/task_functions/">task_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/test_functions/">test_functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/validators/">validators</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/views/">views</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../utils/viewsets/">viewsets</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >uva_jobs</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../uva_jobs/tasks/">tasks</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">For admin</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../admin/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../UVA/UVA/">UVA management</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../admin/permissions/">Permissions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Admin only models details</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../admin/detail/projectjob/">Project Job</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../admin/detail/data_storage_input/">Data Storage input</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../admin/detail/archive/">Archive</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../admin/detail/tarfile/">TAR file</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">ARISE MDS sensor portal help</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">For developers</li>
          <li class="breadcrumb-item">Code Reference</li>
          <li class="breadcrumb-item"><a href="../">external_storage_import</a></li>
      <li class="breadcrumb-item active">models</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">



<a id="external_storage_import.models"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="external_storage_import.models.DataStorageInput" class="doc doc-heading">
            <code>DataStorageInput</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="utils.models.BaseModel">BaseModel</span></code></p>


        <p>Model representing an external data storage input for sensor data import.
Manages connection credentials and provides utilities for user and file management.</p>







              <details class="quote">
                <summary>Source code in <code>external_storage_import\models.py</code></summary>
                <pre class="highlight"><code class="language-python">class DataStorageInput(BaseModel):
    """
    Model representing an external data storage input for sensor data import.
    Manages connection credentials and provides utilities for user and file management.
    """
    name = models.CharField(
        max_length=20,
        unique=True,
        help_text="A unique name for this data storage input."
    )
    username = models.CharField(
        max_length=50,
        unique=True,
        help_text="Username for accessing the external storage."
    )
    password = EncryptedCharField(
        max_length=128,
        help_text="Encrypted password for the storage username."
    )
    address = models.CharField(
        max_length=100,
        unique=True,
        help_text="Network address (IP or hostname) of the external storage."
    )
    owner = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        blank=True,
        related_name="owned_inputstorages",
        on_delete=models.SET_NULL,
        null=True,
        help_text="User who owns this data storage input."
    )

    def __str__(self) -&gt; str:
        """
        Return the string representation of the storage input.
        """
        return self.name

    def init_ssh_client(self) -&gt; 'SSH_client':
        """
        Initialize and return an SSH client for the storage input.
        """
        return SSH_client(self.username, self.password, self.address, 22)

    def check_users_input(self, remove_bad: bool = False) -&gt; None:
        """
        Set up users and check input storage for the linked devices.
        """
        self.setup_users()
        self.check_input(remove_bad)

    def setup_users(self) -&gt; None:
        """
        Ensure all required users for devices exist on the external storage.
        Set up necessary user accounts and permissions.
        """
        connection_success, ssh_client = self.check_connection()
        if not connection_success:
            logger.info(f"{self.name} - unable to connect")
            return

        ssh_client.connect_to_ssh()

        # Get list of all current users
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            'cut -d: -f1 /etc/passwd')
        existing_users = stdout

        all_devices = self.linked_devices.all()
        required_users = all_devices.exclude(
            username="", username__isnull=True).values('username', 'password')
        missing_users = [x for x in required_users if x['username']
                         not in existing_users]

        user_group_name = "ftpuser"

        # check main user group exists
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"grep {user_group_name} /etc/group")

        group_users = stdout

        if len(group_users) == 0:
            # If group does not exist, create it
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"groupadd {user_group_name}", True)

        for user in missing_users:
            username = user["username"]
            user_password = user["password"]

            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"perl -e 'print crypt('{user_password}', 'password')'")
            encrypted_user_password = stdout[0]

            logger.info(f"{self.name} - add user {username}")
            # Add new user, add to ftpuser group
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"useradd -m -p {encrypted_user_password}-N -g {user_group_name} {username}", True)

            # Create a group for this user
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"groupadd g{username}", True)

            # Add service account to the user group
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"usermod -a -G g{username} {self.username}", True)

            # Allow user and service account to own it
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"chown {username}:g{username} /home/{username}", True)

            # allow user and service account to own it
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"chmod -R g+srwx /home/{username}", True)

            # Prevent other users viewing the contents
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"chmod -R o-rwx /home/{username}", True)

        for user in required_users:
            username = user["username"]
            logger.info(f"{self.name} - check user {username} permissions")

            # Check that service account is in user's group
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"id {self.username} | grep -c g{username}")
            grep_result = int(stdout[0])

            if grep_result == 0:
                # check if group exists
                status_code, stdout, stderr = ssh_client.send_ssh_command(
                    f"grep g{username} /etc/group")
                group_users = stdout

                if len(group_users) == 0:
                    # If group does not exist, create it
                    status_code, stdout, stderr = ssh_client.send_ssh_command(
                        f"groupadd g{username}", True)

                if not (self.username in group_users):
                    # If service account is not in the group, add it.
                    status_code, stdout, stderr = ssh_client.send_ssh_command(
                        f"usermod -a -G g{username} {self.username}", True)

                # Try to list user home directory
                status_code, stdout, stderr = ssh_client.send_ssh_command(
                    f"ls -ld /home/{username} | grep -c g{username}")
                grep_result = int(stdout[0])

                if grep_result == 0:
                    # If unable to list directory, make sure group permissions are correct
                    stdin, stdout, stderr = ssh_client.send_ssh_command(
                        f"chown {username}:g{username} /home/{username}", True)

                # allow user and main user to own it
                stdin, stdout, stderr = ssh_client.send_ssh_command(
                    f"chmod -R g+srwx /home/{username}", True)
                # prevent other users viewing the contents
                stdin, stdout, stderr = ssh_client.send_ssh_command(
                    f"chmod -R o-rwx /home/{username}", True)

        ssh_client.close_connection_to_ftp()

    def check_connection(self) -&gt; tuple[bool, 'SSH_client | None']:
        """
        Attempt to initialize an SSH client for this storage input.
        Returns a tuple: (success, SSH_client or None)
        """
        try:
            ssh_client = self.init_ssh_client()
            return True, ssh_client
        except Exception as e:
            logger.info(f"{self.name} - error")
            logger.info(repr(e))
            return False, None

    def check_input(self, remove_bad: bool = False) -&gt; None:
        """
        Check input files and folders for all linked devices.
        Optionally remove invalid files.
        """
        connection_success, ssh_client = self.check_connection()
        if not connection_success:
            logger.info(f"{self.name} - unable to connect")
            return

        ssh_client.connect_to_ftp()
        all_devices = self.linked_devices.all()
        all_dirs_attributes = ssh_client.ftp_sftp.listdir_attr()
        file_names = [x.filename for x in all_dirs_attributes]
        for device in all_devices:
            logger.info(f"{self.name} - {device.device_ID} - checking storage")
            if device.username is None:
                logger.info(
                    f"{self.name} - {device.device_ID} - configured incorrectly")
                continue
            # check for folder of this device
            if device.username not in file_names:
                logger.info(
                    f"{self.name} - {device.device_ID} - not found on external storage")
                continue

            # check for files
            device_dir_attribute = ssh_client.ftp_sftp.listdir_attr(
                device.username)
            device_file_names = [
                x.filename for x in device_dir_attribute if all([y != '' for y in splitext(x.filename)])]
            if len(device_file_names) == 0:
                logger.info(
                    f"{self.name} - {device.device_ID} - no files on external storage")
                continue

            files = []
            for filename in device_file_names:
                try:
                    with ssh_client.ftp_sftp.open(join(device.username, filename), bufsize=32768) as f:
                        f.set_pipelined
                        f.prefetch()
                        f_bytes = io.BytesIO(f.read())
                        file_object = File(f_bytes, name=filename)
                        files.append(file_object)
                except Exception as e:
                    logger.error(e)

            # import files
            downloaded_files, invalid_files, existing_files, status = create_file_objects(
                files, device_object=device)
            logger.info(f"{self.name} - {device.device_ID} - {status}")

            # delete files that are succesfully downloaded
            for file_obj in downloaded_files:
                logger.info(
                    f"{self.name} - {device.device_ID} - {file_obj.original_name} succesfully downloaded")
                if not settings.DEVMODE:
                    ssh_client.ftp_sftp.remove(
                        join(device.username, file_obj.original_name))
                    logger.info(
                        f"{self.name} - {device.device_ID} - {file_obj.original_name} removed")

            for problem_file in invalid_files:
                logger.info(
                    f"{self.name} - {device.device_ID} - {problem_file}")
                if remove_bad:
                    mtime = ssh_client.ftp_sftp.stat(
                        join(device.username, filename)).st_mtime
                    last_modified = datetime.fromtimestamp(mtime)
                    if (datetime.now() - last_modified) &lt;= timedelta(days=7):
                        ssh_client.ftp_sftp.remove(
                            join(device.username, file_obj.original_name))
                        logger.info(
                            f"{self.name} - {device.device_ID} - {file_obj.original_name} removed")

        ssh_client.close_connection_to_ftp()</code></pre>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="external_storage_import.models.DataStorageInput.__str__" class="doc doc-heading">
            <code class="highlight language-python">__str__()</code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the string representation of the storage input.</p>


            <details class="quote">
              <summary>Source code in <code>external_storage_import\models.py</code></summary>
              <pre class="highlight"><code class="language-python">def __str__(self) -&gt; str:
    """
    Return the string representation of the storage input.
    """
    return self.name</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="external_storage_import.models.DataStorageInput.check_connection" class="doc doc-heading">
            <code class="highlight language-python">check_connection()</code>

</h3>


    <div class="doc doc-contents ">

        <p>Attempt to initialize an SSH client for this storage input.
Returns a tuple: (success, SSH_client or None)</p>


            <details class="quote">
              <summary>Source code in <code>external_storage_import\models.py</code></summary>
              <pre class="highlight"><code class="language-python">def check_connection(self) -&gt; tuple[bool, 'SSH_client | None']:
    """
    Attempt to initialize an SSH client for this storage input.
    Returns a tuple: (success, SSH_client or None)
    """
    try:
        ssh_client = self.init_ssh_client()
        return True, ssh_client
    except Exception as e:
        logger.info(f"{self.name} - error")
        logger.info(repr(e))
        return False, None</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="external_storage_import.models.DataStorageInput.check_input" class="doc doc-heading">
            <code class="highlight language-python">check_input(remove_bad=False)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Check input files and folders for all linked devices.
Optionally remove invalid files.</p>


            <details class="quote">
              <summary>Source code in <code>external_storage_import\models.py</code></summary>
              <pre class="highlight"><code class="language-python">def check_input(self, remove_bad: bool = False) -&gt; None:
    """
    Check input files and folders for all linked devices.
    Optionally remove invalid files.
    """
    connection_success, ssh_client = self.check_connection()
    if not connection_success:
        logger.info(f"{self.name} - unable to connect")
        return

    ssh_client.connect_to_ftp()
    all_devices = self.linked_devices.all()
    all_dirs_attributes = ssh_client.ftp_sftp.listdir_attr()
    file_names = [x.filename for x in all_dirs_attributes]
    for device in all_devices:
        logger.info(f"{self.name} - {device.device_ID} - checking storage")
        if device.username is None:
            logger.info(
                f"{self.name} - {device.device_ID} - configured incorrectly")
            continue
        # check for folder of this device
        if device.username not in file_names:
            logger.info(
                f"{self.name} - {device.device_ID} - not found on external storage")
            continue

        # check for files
        device_dir_attribute = ssh_client.ftp_sftp.listdir_attr(
            device.username)
        device_file_names = [
            x.filename for x in device_dir_attribute if all([y != '' for y in splitext(x.filename)])]
        if len(device_file_names) == 0:
            logger.info(
                f"{self.name} - {device.device_ID} - no files on external storage")
            continue

        files = []
        for filename in device_file_names:
            try:
                with ssh_client.ftp_sftp.open(join(device.username, filename), bufsize=32768) as f:
                    f.set_pipelined
                    f.prefetch()
                    f_bytes = io.BytesIO(f.read())
                    file_object = File(f_bytes, name=filename)
                    files.append(file_object)
            except Exception as e:
                logger.error(e)

        # import files
        downloaded_files, invalid_files, existing_files, status = create_file_objects(
            files, device_object=device)
        logger.info(f"{self.name} - {device.device_ID} - {status}")

        # delete files that are succesfully downloaded
        for file_obj in downloaded_files:
            logger.info(
                f"{self.name} - {device.device_ID} - {file_obj.original_name} succesfully downloaded")
            if not settings.DEVMODE:
                ssh_client.ftp_sftp.remove(
                    join(device.username, file_obj.original_name))
                logger.info(
                    f"{self.name} - {device.device_ID} - {file_obj.original_name} removed")

        for problem_file in invalid_files:
            logger.info(
                f"{self.name} - {device.device_ID} - {problem_file}")
            if remove_bad:
                mtime = ssh_client.ftp_sftp.stat(
                    join(device.username, filename)).st_mtime
                last_modified = datetime.fromtimestamp(mtime)
                if (datetime.now() - last_modified) &lt;= timedelta(days=7):
                    ssh_client.ftp_sftp.remove(
                        join(device.username, file_obj.original_name))
                    logger.info(
                        f"{self.name} - {device.device_ID} - {file_obj.original_name} removed")

    ssh_client.close_connection_to_ftp()</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="external_storage_import.models.DataStorageInput.check_users_input" class="doc doc-heading">
            <code class="highlight language-python">check_users_input(remove_bad=False)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Set up users and check input storage for the linked devices.</p>


            <details class="quote">
              <summary>Source code in <code>external_storage_import\models.py</code></summary>
              <pre class="highlight"><code class="language-python">def check_users_input(self, remove_bad: bool = False) -&gt; None:
    """
    Set up users and check input storage for the linked devices.
    """
    self.setup_users()
    self.check_input(remove_bad)</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="external_storage_import.models.DataStorageInput.init_ssh_client" class="doc doc-heading">
            <code class="highlight language-python">init_ssh_client()</code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize and return an SSH client for the storage input.</p>


            <details class="quote">
              <summary>Source code in <code>external_storage_import\models.py</code></summary>
              <pre class="highlight"><code class="language-python">def init_ssh_client(self) -&gt; 'SSH_client':
    """
    Initialize and return an SSH client for the storage input.
    """
    return SSH_client(self.username, self.password, self.address, 22)</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="external_storage_import.models.DataStorageInput.setup_users" class="doc doc-heading">
            <code class="highlight language-python">setup_users()</code>

</h3>


    <div class="doc doc-contents ">

        <p>Ensure all required users for devices exist on the external storage.
Set up necessary user accounts and permissions.</p>


            <details class="quote">
              <summary>Source code in <code>external_storage_import\models.py</code></summary>
              <pre class="highlight"><code class="language-python">def setup_users(self) -&gt; None:
    """
    Ensure all required users for devices exist on the external storage.
    Set up necessary user accounts and permissions.
    """
    connection_success, ssh_client = self.check_connection()
    if not connection_success:
        logger.info(f"{self.name} - unable to connect")
        return

    ssh_client.connect_to_ssh()

    # Get list of all current users
    status_code, stdout, stderr = ssh_client.send_ssh_command(
        'cut -d: -f1 /etc/passwd')
    existing_users = stdout

    all_devices = self.linked_devices.all()
    required_users = all_devices.exclude(
        username="", username__isnull=True).values('username', 'password')
    missing_users = [x for x in required_users if x['username']
                     not in existing_users]

    user_group_name = "ftpuser"

    # check main user group exists
    status_code, stdout, stderr = ssh_client.send_ssh_command(
        f"grep {user_group_name} /etc/group")

    group_users = stdout

    if len(group_users) == 0:
        # If group does not exist, create it
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"groupadd {user_group_name}", True)

    for user in missing_users:
        username = user["username"]
        user_password = user["password"]

        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"perl -e 'print crypt('{user_password}', 'password')'")
        encrypted_user_password = stdout[0]

        logger.info(f"{self.name} - add user {username}")
        # Add new user, add to ftpuser group
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"useradd -m -p {encrypted_user_password}-N -g {user_group_name} {username}", True)

        # Create a group for this user
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"groupadd g{username}", True)

        # Add service account to the user group
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"usermod -a -G g{username} {self.username}", True)

        # Allow user and service account to own it
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"chown {username}:g{username} /home/{username}", True)

        # allow user and service account to own it
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"chmod -R g+srwx /home/{username}", True)

        # Prevent other users viewing the contents
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"chmod -R o-rwx /home/{username}", True)

    for user in required_users:
        username = user["username"]
        logger.info(f"{self.name} - check user {username} permissions")

        # Check that service account is in user's group
        status_code, stdout, stderr = ssh_client.send_ssh_command(
            f"id {self.username} | grep -c g{username}")
        grep_result = int(stdout[0])

        if grep_result == 0:
            # check if group exists
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"grep g{username} /etc/group")
            group_users = stdout

            if len(group_users) == 0:
                # If group does not exist, create it
                status_code, stdout, stderr = ssh_client.send_ssh_command(
                    f"groupadd g{username}", True)

            if not (self.username in group_users):
                # If service account is not in the group, add it.
                status_code, stdout, stderr = ssh_client.send_ssh_command(
                    f"usermod -a -G g{username} {self.username}", True)

            # Try to list user home directory
            status_code, stdout, stderr = ssh_client.send_ssh_command(
                f"ls -ld /home/{username} | grep -c g{username}")
            grep_result = int(stdout[0])

            if grep_result == 0:
                # If unable to list directory, make sure group permissions are correct
                stdin, stdout, stderr = ssh_client.send_ssh_command(
                    f"chown {username}:g{username} /home/{username}", True)

            # allow user and main user to own it
            stdin, stdout, stderr = ssh_client.send_ssh_command(
                f"chmod -R g+srwx /home/{username}", True)
            # prevent other users viewing the contents
            stdin, stdout, stderr = ssh_client.send_ssh_command(
                f"chmod -R o-rwx /home/{username}", True)

    ssh_client.close_connection_to_ftp()</code></pre>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../filtersets/" class="btn btn-neutral float-left" title="filtersets"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../serializers/" class="btn btn-neutral float-right" title="serializers">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../filtersets/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../serializers/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
